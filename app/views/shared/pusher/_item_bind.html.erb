<script src="https://js.pusher.com/3.0/pusher.min.js"></script>
<script>
$(document).ready(function() {

  var pusher = new Pusher('<%= Pusher.key %>'); // uses your APP KEY
  console.log("$$$$");
  console.log('<%= Pusher.key %>');
  pusher.unsubscribe('<%= current_user.push_channel %>');
  console.log('<%= current_user.push_channel %>');

  var channel = pusher.subscribe('<%= current_user.push_channel %>');
  channel.bind('item-creation', function(data) {
    console.log("bind");
    var doesnt_exist = $("#item"+data["id"]).length == 0;
    var box = $("#item-list");
    if (doesnt_exist) {
      $("#item-list").append(data["html_as_string"]);
    } else {
      $("#item"+data["id"]).replaceWith(data["html_as_string"]);
    }
    
    var scrollBtm = document.getElementById("sBtm");  
    //-------------------------------- Btm --------------------------------
    scrollBtm.scrollIntoView();
    scrollBtm.scrollIntoView(false);
    scrollBtm.scrollIntoView({block: "end"});
    scrollBtm.scrollIntoView({block: "end", behavior: "smooth"});

    $("#item-template").each( function(index, element){
        if ($(this).find('#item-message-template').text() == data["message"]) {
          $(this).remove();
        }
    });
  }); 

  channel.bind('item-save', function(data) {
    console.log("item-save bind");
    var exists = $("#item"+data["id"]).length > 0;
    if (exists) {
      $("#item"+data["id"]).replaceWith(data["html_as_string"]);
    }
  }); 
});

</script>
