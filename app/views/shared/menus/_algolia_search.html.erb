<script src="//cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
<script src="//cdn.jsdelivr.net/algoliasearch.helper/1/algoliasearch.helper.min.js"></script>
<script>
  $(document).ready(function() {
    var client = algoliasearch("<%= ENV['ALGOLIASEARCH_APPLICATION_ID'] %>", "<%= ENV['ALGOLIASEARCH_API_KEY'] %>");
    var itemIndex = client.initIndex('Item');
    var bucketIndex = client.initIndex('Bucket');
    var bucketList = $("body #bucket-list"); 
    var searchList = $("body .sorted-list"); 
    var bucketMenuHeader = $("body #bucket-menu-header");
    var itemList = $("body #item-list");
    var nudgeList = $("body .nudges-list");
    var searchInput = $("body #search-thoughts-input"); 
    var itemEntryForm = $("body .rapid-add"); 
    var scrollToBottom = $("body #sBtm"); 
    var searchResultsList = $("body .search-results-list");
    var searchResultsItemList = $('body #search-results-item-list');
    var searchResultsBucketList = $('body #search-results-bucket-list');
    var bucketTemplate = "<%= escape_javascript(render partial: 'shared/search/search_bucket_template') %>";
    var itemTemplate = "<%= escape_javascript(render partial: 'shared/search/search_item_template') %>";

    searchResultsList.hide(); 

    searchInput.keyup(function(){
      var enteredText = $(this).val(); 
      if (enteredText.length < 1) {
        finishedSearching(); 
      } else {
        beganSearching(enteredText); 
      };
    });


    function finishedSearching(){
      searchResultsItemList.html(""); 
      searchResultsBucketList.html(""); 
      bucketMenuHeader.show(); 
      bucketList.show(); 
      itemList.show(); 
      nudgeList.show(); 
      searchResultsList.hide(); 
      itemEntryForm.show(); 
      scrollToBottom.show(); 
    }

    function beganSearching(enteredText){
      algoliaSearch(enteredText); 
      searchResultsItemList.html(""); 
      searchResultsBucketList.html(""); 
      bucketMenuHeader.hide(); 
      bucketList.hide(); 
      itemList.hide(); 
      nudgeList.hide(); 
      searchResultsList.show(); 
      itemEntryForm.hide(); 
      scrollToBottom.hide(); 
    }

    function algoliaSearch(enteredText) {
      algoliaItemSearch(enteredText); 
      algoliaBucketSearch(enteredText); 
    }

    function algoliaItemSearch(enteredText) {
      itemIndex.search(enteredText, { hitsPerPage: 10, page: 0, numericFilters:"user_ids_array=<%= current_user.id %>" }, function(success, hitsHash) {
        if (hitsHash && hitsHash.hits) {
          var hits = hitsHash.hits; 
          for (var i = 0; i < hits.length; i++) {
            appendItemWithTemplate(itemTemplate, hits[i]); 
          };
        };
      });
    }

    function algoliaBucketSearch(enteredText) {
      bucketIndex.search(enteredText, { hitsPerPage: 2, page: 0, numericFilters:"user_ids_array=<%= current_user.id %>" }, function(success, hitsHash) {
        if (hitsHash && hitsHash.hits) {
          var hits = hitsHash.hits; 
          for (var i = 0; i < hits.length; i++) {
            appendBucketWithTemplate(bucketTemplate, hits[i]); 
            console.log("bucket = "+hits[i].first_name);
          };
        };
      });
    }

    function appendItemWithTemplate(template, hit) {
      var $jQueryObject = $($.parseHTML(template));
      $jQueryObject.find('#search-list-template').html(hit.message);
      $jQueryObject.find('a').attr("href", '/items/'+hit.id);
      searchResultsItemList.append($jQueryObject);
    }

    function appendBucketWithTemplate(template, hit) {
      var $jQueryObject = $($.parseHTML(template));
      $jQueryObject.find('#search-bucket-firstname').html(hit.first_name);
      $jQueryObject.find('#bucket-header-link').attr("href", '/buckets/'+hit.id+'/info');
      searchResultsBucketList.append($jQueryObject);
    }
  });
</script>